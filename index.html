<!doctype>
<html>
  <head>
    <title>üí•</title>
    <!-- üëã this is a wip don't be mean -->
    <!-- check out https://github.com/muan/emoji-minesweeper -->
    <style type="text/css">
    body {
      font-family: AppleColorEmoji;
      font-size: 15px;
      text-align: center;
    }
    div, span {
      box-sizing: border-box;
    }

    .cell {
      width: 25px;
      height: 25px;
      display: inline-block;
      position: relative;
      padding: 2px 3px;
      vertical-align: middle;
      cursor: default;
    }

    .cell.masked,
    .masked.flagged {
      font-size: 0;
      cursor: pointer;
    }

    .masked.flagged:before,
    .cell.masked:before {
      font-size: 15px;
    }

    #map {
      display: inline-block;
      border: 5px solid #eee;
      border-radius: 3px;
      margin: 30px 0;
    }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var Game = function (x, y, bomb_n, emojiset){
        this.cell_n = x*y
        if (this.cell_n > 500) { alert("too big, go away"); return false }
        this.emojiset = emojiset
        this.map = document.getElementById("map")
        this.map.innerHTML = ""
        this.x = x
        this.y = y
        this.bomb_n = bomb_n
        this.rate = bomb_n/this.cell_n
        this.numbermoji = [this.emojiset[0], "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£"]

        this.init()
      }

      Game.prototype.init = function () {
        var that = this
        this.bomb_arr().forEach(function (a, i) {
          var mine = that.mine(a)
          var x_cord = Math.floor((i+1)%that.x) || that.x
          var y_cord = Math.ceil((i+1)/that.x)
          mine.classList.add("x"+ x_cord, "y" + y_cord)
          mine.neightbors = [(".x" + x_cord + ".y" + (y_cord + 1)), (".x" + x_cord + ".y" + (y_cord - 1)),
                             (".x" + (x_cord + 1) + ".y" + (y_cord + 1)), (".x" + (x_cord + 1) + ".y" + (y_cord - 1)), (".x" + (x_cord + 1) + ".y" + y_cord),
                             (".x" + (x_cord - 1) + ".y" + (y_cord + 1)), (".x" + (x_cord - 1) + ".y" + (y_cord - 1)), (".x" + (x_cord - 1) + ".y" + y_cord)]

          that.map.appendChild(mine)
          if (x_cord === that.x) that.map.appendChild(document.createElement("br"))
        })

        var cells = document.querySelectorAll(".cell")
        for(var i=0; i < cells.length; i++) {
          var obj = cells[i]
          if (obj.bomb) { continue }
          var count = 0
          Array.prototype.forEach.call(document.querySelectorAll(obj.neightbors), function (n) {
            if (n.bomb) count ++
          })
          if (count === 0) obj.classList.add("space")
          obj.innerText = that.numbermoji[count]
        }

        this.bindEvents()
        this.customizeEmoji()
      }

      Game.prototype.bindEvents = function () {
        window.classes = []
        var that = this
        var cells = document.getElementsByClassName("cell")
        Array.prototype.forEach.call(cells, function (target){
          target.addEventListener("click", function() {
            if (!target.classList.contains("masked") || target.classList.contains("flagged")) return false
            target.classList.remove("masked")
            if (target.classList.contains("space")) {
              var neightbors = Array.prototype.filter.call(document.querySelectorAll(target.neightbors), function (neightbor) { return neightbor.classList.contains("masked") })
              Array.prototype.forEach.call(neightbors, function (n) { n.click() })
            }
            that.game()
          })

          target.addEventListener("contextmenu", function (evt) {
            target.classList.contains("flagged") ? target.classList.remove("flagged") : target.classList.add("flagged")
            evt.preventDefault()
          })
        })
      }

      Game.prototype.game = function () {
        if (this.result) return false
        var cells = document.getElementsByClassName("cell")
        var masked = document.getElementsByClassName("masked")
        var bombs = Array.prototype.filter.call(cells, function (cell) {
          return cell.bomb === true && !cell.classList.contains("masked")
        })

        if (bombs.length > 0) {
          Array.prototype.forEach.call(masked, function(cell) { cell.classList.remove("masked") })
          this.result = "lost"
          alert("you lost")
        } else if (document.getElementsByClassName("masked").length === this.bomb_n) {
          console.log(masked)
          Array.prototype.forEach.call(masked, function(cell) { cell.classList.remove("masked") })
          this.result = "won"
          alert("you won")
        }
      }

      Game.prototype.mine = function (bomb) {
        var base = document.createElement("span")
        base.className = "cell masked"
        if (bomb) {
          base.bomb = true
          base.innerText = this.emojiset[1]
        }
        return base
      }

      Game.prototype.bomb_arr = function () {
        var chance = this.rate * this.cell_n
        var arr = []
        for(var i=0; i < chance; i++) {
          arr.push(true)
        }
        for(var n=0; n < (this.cell_n - chance); n++) {
          arr.push(false)
        }
        return this.shuffle(arr)
      }

      Game.prototype.customizeEmoji = function () {
        var oldstyle = document.querySelector("#map style")
        if (oldstyle) oldstyle.remove()
        var style = document.createElement("style")
        style.innerText = ".cell.masked:before { content: '" + this.emojiset[3] + "'; } .masked.flagged:before { content: '" + this.emojiset[2] + "'; }"
        this.map.appendChild(style)
      }

      Game.prototype.shuffle = function (array) {
        var currentIndex = array.length, temporaryValue, randomIndex
        while (0 !== currentIndex) {
          randomIndex = Math.floor(Math.random() * currentIndex)
          currentIndex -= 1
          temporaryValue = array[currentIndex]
          array[currentIndex] = array[randomIndex]
          array[randomIndex] = temporaryValue
        }
        return array
      }
      new Game(10, 10, 10, ["üå±", "üí•", "üö©", "‚óªÔ∏è"])
      console.log("Use: `new Game(cols, rows, bombs, [emptyemoji, bombemoji, flagemoji, starteremoji])` to start a new game with customizations.")
      console.log(' Eg: `new Game(10, 10, 10, ["Ôå±", "Ôí•", "Ôö©", "‚óªÔ∏è"])`')
      console.log(' Or: `new Game(16, 16, 30, ["üê±", "üìõ", "üí£", "üîç"])`')
    </script>
  </body>
</html>