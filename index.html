<!doctype>
<html>
  <head>
    <title>üí•</title>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <style type="text/css">
    body {
      font-family: AppleColorEmoji;
      font-size: 15px;
      text-align: center;
    }
    div, span {
      box-sizing: border-box;
    }
    .cell {
      width: 25px;
      height: 25px;
      display: inline-block;
      position: relative;
      padding: 2px 3px;
      vertical-align: middle;
      cursor: default;
    }

    .cell.masked {
      font-size: 0;
      cursor: pointer;
    }
    .cell.masked:before {
      content: "‚óªÔ∏è";
      font-size: 15px;
    }

    .map {
      display: inline-block;
      border: 5px solid #eee;
      border-radius: 3px;
      margin: 30px 0;
    }
    </style>
  </head>
  <body>
    <div class="map"></div>
    <script>
      var Game = function (x, y, bomb_n){
        this.cell_n = x*y
        if (this.cell_n > 500) { alert("too big, go away"); return false }
        this.map = $(".map").html("")
        this.x = x
        this.y = y
        this.rate = bomb_n/this.cell_n
        this.numbermoji = ["üå±", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£"]

        this.init()
      }

      Game.prototype.init = function () {
        var that = this
        this.bomb_arr().forEach(function(a, i) {
          var x_cord = Math.floor((i+1)%that.x) || that.x
          var y_cord = Math.ceil((i+1)/that.x)
          that.map.append(that.mine(a).addClass("x"+ x_cord + " y" + y_cord))
          if (x_cord === that.x) that.map.append("<br>")
        })

        $(".cell:not(.bomb)").each(function(i, o) {
          var count = 0
          that.getNeightbors(o).forEach(function(n) {
            if ($(n).hasClass("bomb")) count ++
          })
          if (count === 0) $(o).addClass("space")
          o.innerText = that.numbermoji[count]
        })

        this.bindEvents()
      }

      Game.prototype.getNeightbors = function(obj) {
        var arr = []
        var x_p = obj.className.match(/x(\d+)/)[1]
        var y_p = obj.className.match(/y(\d+)/)[1]
        arr.push($(".masked.x" + x_p + ".y" + (Number(y_p) + 1))[0])
        arr.push($(".masked.x" + x_p + ".y" + (Number(y_p) - 1))[0])
        arr.push($(".masked.x" + (Number(x_p) + 1) + ".y" + y_p)[0])
        arr.push($(".masked.x" + (Number(x_p) - 1) + ".y" + y_p)[0])
        arr.push($(".masked.x" + (Number(x_p) + 1) + ".y" + (Number(y_p) - 1))[0])
        arr.push($(".masked.x" + (Number(x_p) + 1) + ".y" + (Number(y_p) + 1))[0])
        arr.push($(".masked.x" + (Number(x_p) - 1) + ".y" + (Number(y_p) - 1))[0])
        arr.push($(".masked.x" + (Number(x_p) - 1) + ".y" + (Number(y_p) + 1))[0])
        return arr.filter(function(e){return e})
      }

      Game.prototype.bindEvents = function () {
        window.classes = []
        var that = this
        $(".cell").on("click", function() {
          $(this).removeClass("masked")
          if (this.classList.contains("bomb")) {
            $(".cell").removeClass("masked")
            that.game()

          } else if ($(this).hasClass("space")) {
            var neightbors = that.getNeightbors(this)
            neightbors.forEach(function(n) { $(n).removeClass("masked") })
            neightbors.forEach(function(n) { $(n).click() })
          }

          that.game()
        })
      }

      Game.prototype.game = function () {
        if (this.result) return false
        if ($(".bomb:not(.masked)").length > 0) {
          this.result = "lost"
          alert("you lost")
        } else if ($(".masked").length === $(".bomb").length) {
          this.result = "won"
          alert("you won")
        }
      }

      Game.prototype.mine = function (number) {
        var base = $("<span class='cell masked'>")
        if (number > 0) {
          base.addClass("bomb").text("üí•")
        }
        return base
      }

      Game.prototype.bomb_arr = function () {
        var chance = this.rate * this.cell_n
        var arr = []
        for(var i=0; i < chance; i++) {
          arr.push(true)
        }
        for(var n=0; n < (this.cell_n - chance); n++) {
          arr.push(false)
        }
        return this.shuffle(arr)
      }

      Game.prototype.shuffle = function (array) {
        var currentIndex = array.length, temporaryValue, randomIndex
        while (0 !== currentIndex) {
          randomIndex = Math.floor(Math.random() * currentIndex)
          currentIndex -= 1
          temporaryValue = array[currentIndex]
          array[currentIndex] = array[randomIndex]
          array[randomIndex] = temporaryValue
        }
        return array
      }
      new Game(10, 10, 10)
    </script>
  </body>
</html>